{% extends "base.html" %}
{% load i18n %}
{% block content %}
<h1>{{title}}</h1>
{% if test_name %}
<h2>{% trans "Executed test:" %} {{test_name}}</h2>
{% endif %}

<h2>{% trans "Run now!"%}</h2>
<form method="post">
<input type="hidden" name="test" value="1">
<input type="submit" name="run" value="Run">
</form>

<a id="reload" href="javascript:reload_results()">{% trans "Reload" %}</a>

<h2>{% trans "Latest executions" %}</h2>

<ul id="results">
</ul>

<script>
reload_results = function(){
	var pollingd=false;
	$.get('/results', function(data){
		do_poll=false;
		var ul=$('#results')
		ul.html('')
		var lis=[]
		for (var k in data){
			var li=$('<li>').html($('<a>').text(data[k].name).attr('href','/result/'+k))
			li.append('<br/>' + (new Date(Number(data[k].timestamp)*1000)) + '<br>Result: ' + data[k].result)
			
			if (data[k].result==0)
				li.addClass("ok");
			else if (data[k].running){
				li.addClass("running");
				do_poll=true;
			}
			else
				li.addClass("error");
			
			li.attr('timestamp',data[k].timestamp)
			
			lis.push(li)
		}
		
		lis=lis.sort(function(a,b){ 
			return a.attr('timestamp') < b.attr('timestamp') ? 1 : -1
			})
		ul.append(lis)
		
		if (do_poll && !pollingd)
			pollingd=setTimeout(reload_results, 1000);
		if (!do_poll && pollingd){
			clearInterval(pollingd)
			pollingd=false;
		}
	},'json')
}

$(document).ready(function(){
	reload_results();
	$('#reload').focus()
})
</script>

{% endblock %}
